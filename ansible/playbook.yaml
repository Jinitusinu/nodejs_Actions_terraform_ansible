---
- name: Setup Node.js testing environment with Chrome and Selenium
  hosts: all
  become: yes

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install prerequisites
      apt:
        name:
          - curl
          - gnupg
          - unzip
          - ca-certificates
        state: present

    - name: Add Google Chrome GPG key
      apt_key:
        url: https://dl.google.com/linux/linux_signing_key.pub
        state: present

    - name: Add Google Chrome repository
      apt_repository:
        repo: deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main
        state: present
        filename: google-chrome

  tasks:
    - name: Install Node.js and npm
      apt:
        name:
          - nodejs
          - npm
        state: present

    - name: Install Google Chrome
      apt:
        name: google-chrome-stable
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Get installed Chrome version
      command: google-chrome --version
      register: chrome_version_output
      changed_when: false

    - name: Extract Chrome major version
      set_fact:
        chrome_major_version: "{{ chrome_version_output.stdout | regex_search('Google Chrome ([0-9]+)', '\\1') }}"

    - name: Get latest compatible ChromeDriver version
      uri:
        url: "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_{{ chrome_major_version }}"
        return_content: yes
      register: chromedriver_version_response

    - name: Set ChromeDriver version fact
      set_fact:
        chromedriver_version: "{{ chromedriver_version_response.content }}"

    - name: Construct ChromeDriver download URL
      set_fact:
        chromedriver_url: "https://chromedriver.storage.googleapis.com/{{ chromedriver_version }}/chromedriver_linux64.zip"

    - name: Download ChromeDriver zip
      get_url:
        url: "{{ chromedriver_url }}"
        dest: /tmp/chromedriver.zip
        mode: '0644'

    - name: Unzip ChromeDriver
      unarchive:
        src: /tmp/chromedriver.zip
        dest: /usr/local/bin/
        remote_src: yes
        mode: '0755'

    - name: Ensure test project directory exists
      file:
        path: /home/ubuntu/test-project
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Initialize npm project if not exists
      shell: |
        cd /home/ubuntu/test-project && npm init -y
      args:
        creates: /home/ubuntu/test-project/package.json

    - name: Install test dependencies
      shell: |
        cd /home/ubuntu/test-project && \
        npm install --save-dev mocha chai selenium-webdriver mochawesome
      args:
        chdir: /home/ubuntu/test-project

    - name: Verify Mocha installation
      command: npx mocha --version
      args:
        chdir: /home/ubuntu/test-project
